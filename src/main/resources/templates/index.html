<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X.com Clone - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<div th:if="${signupSuccessMessage}" class="success-banner success-banner-fixed">
    <p th:text="${signupSuccessMessage}" style="margin: 0;"></p>
</div>
<div th:if="${errorMessage}" class="error-banner error-banner-fixed">
    <p th:text="${errorMessage}" style="margin: 0;"></p>
</div>
<div th:if="${successMessage}" class="success-banner success-banner-fixed">
    <p th:text="${successMessage}" style="margin: 0;"></p>
</div>

<div class="main-container">

    <div class="left-sidebar">
        <h2 class="text-3xl font-extrabold mb-6 text-white">X.com</h2>

        <a th:href="@{/}" class="menu-item">
            <span class="text-2xl">ğŸ </span>
            <span>í™ˆ</span>
        </a>

        <div th:if="${currentUser != null}" class="mb-4">
            <a th:href="@{/users/profile/{username}(username=${currentUser.username})}" class="menu-item">
                <span class="text-2xl">ğŸ‘¤</span>
                <span>í”„ë¡œí•„</span>
            </a>
            <a th:href="@{/users/profile/edit}" class="menu-item">
                <span class="text-2xl">âš™ï¸</span>
                <span>í”„ë¡œí•„ ìˆ˜ì •</span>
            </a>
        </div>

        <div th:if="${currentUser == null}" class="mt-4">
            <a th:href="@{/users/login}" class="action-button">ë¡œê·¸ì¸</a>
            <a th:href="@{/users/signup}" class="action-button signup-button">íšŒì›ê°€ì…</a>
        </div>

        <div th:if="${currentUser != null}" class="profile-section mt-auto">
            <a th:href="@{/users/profile/{username}(username=${currentUser.username})}"
               style="text-decoration: none; display: block; color: inherit;">
                <div class="flex items-center mb-3">
                    <img th:src="@{${currentUser.profileImageUrl ?: '/images/default_profile.png'}}"
                         alt="Profile Image"
                         class="profile-image-small mr-3">
                    <div>
                        <p class="text-lg font-bold text-white" th:text="${currentUser.username} + 'ë‹˜'"></p>
                        <p class="text-sm" style="color: #71767B;">
                            @<span th:text="${currentUser.username}"></span>
                        </p>
                    </div>
                </div>
            </a>
            <form th:action="@{/users/logout}" method="post">
                <button type="submit" class="action-button">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </div>
    </div>

    <div class="timeline">
        <div class="header">í™ˆ</div>

        <div th:if="${currentUser != null}" class="post-input-area"
             style="border-bottom: 8px solid #2F3336;">
            <form onsubmit="createPost(event)" enctype="multipart/form-data" style="display: flex; flex: 1;">
                <img th:src="@{${currentUser.profileImageUrl ?: '/images/default_profile.png'}}"
                     alt="User Image" class="profile-image">
                <div class="post-header-grid ml-3">
                    <textarea id="postContent" name="content" rows="3"
                              placeholder="ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìˆë‚˜ìš”?"></textarea>

                    <input id="postFiles" type="file" name="mediaFiles" multiple
                           style="margin-top: 10px; color: #E7E9EA;">

                    <div style="text-align: right; border-top: 1px solid #2F3336; padding-top: 10px;">
                        <button type="submit" class="post-submit-btn">ê²Œì‹œí•˜ê¸°</button>
                    </div>
                </div>
            </form>
        </div>

        <div th:if="${timelineItems.isEmpty()}" class="no-posts" style="padding: 20px; text-align: center; color: #71767B;">
            <p>ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div th:each="item : ${timelineItems}" class="post-card" th:id="|item-${item.originalPost.postId}|">
            <div th:if="${item.isRetweet}" class="retweet-indicator"
                 style="font-size: 13px; color: #71767B; margin-left: 55px; margin-bottom: 5px;">
                ğŸ” <span th:text="${item.actionUser.username}"></span>ë‹˜ì´ ë¦¬íŠ¸ìœ—í–ˆìŠµë‹ˆë‹¤.
            </div>

            <img th:src="@{${item.originalPost.user.profileImageUrl ?: '/images/default_profile.png'}}"
                 alt="Author Image" class="profile-image">

            <div class="post-header-grid">
                <div class="post-info flex items-center">
                    <a th:href="@{/users/profile/{username}(username=${item.originalPost.user.username})}"
                       class="profile-link flex items-center hover:text-gray-200"
                       style="text-decoration: none; color: inherit;">
                        <span th:text="${item.originalPost.user.username}" class="font-bold hover:underline"></span>
                        <span style="font-weight: normal; color: #71767B; margin-left: 5px;">
                            @<span th:text="${item.originalPost.user.username}"></span>
                        </span>
                    </a>
                    <span style="color: #71767B; margin-left: 5px;">Â·</span>
                    <span th:text="${#temporals.format(item.originalPost.createdAt, 'HH:mm')}"
                          style="color: #71767B; margin-left: 5px;"></span>
                </div>

                <div class="post-content">
                    <p th:text="${item.originalPost.content}"></p>
                </div>

                <div class="post-images" th:if="${item.originalPost.mediaList != null}">
                    <img th:each="media : ${item.originalPost.mediaList}" th:src="@{${media.fileUrl}}"
                         alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width: 100%; border-radius: 10px; margin-top: 10px;">
                </div>

                <div th:if="${currentUser != null and item.originalPost.user.userId == currentUser.userId}"
                     style="margin-top: 10px; text-align: left;">
                    <button type="button"
                            style="background: transparent; color: #F4212E; border: none; cursor: pointer; font-size: 14px;"
                            th:onclick="|deletePost(${item.originalPost.postId})|">
                        ì‚­ì œ
                    </button>
                </div>

                <div class="post-actions">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <form th:if="${currentUser != null}" th:action="@{|/posts/${item.originalPost.postId}/like|}" method="post" style="display: inline;">
                            <button type="submit" style="background: transparent; border: none; color: #E7E9EA; cursor: pointer;">
                                â¤ï¸ <span th:text="${#lists.size(item.originalPost.likes)}">0</span>
                            </button>
                        </form>

                        <form th:if="${currentUser != null}" th:action="@{|/posts/${item.originalPost.postId}/retweet|}" method="post" style="display: inline;">
                            <button type="submit" style="background: transparent; border: none; color: #E7E9EA; cursor: pointer;">
                                ğŸ” <span th:text="${item.retweetCount}">0</span>
                            </button>
                        </form>

                        <span style="color: #71767B; margin-left: 10px;">
                            ğŸ’¬ <span th:text="${#lists.size(item.originalPost.replies)}">0</span> ëŒ“ê¸€
                        </span>
                    </div>
                </div>
            </div>

            <div th:if="${currentUser != null}" class="reply-input-area" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2F3336;">
                <form th:action="@{|/posts/${item.originalPost.postId}/reply|}" method="post" style="display: flex; flex: 1; align-items: flex-start;">
                    <img th:src="@{${currentUser.profileImageUrl ?: '/images/default_profile.png'}}"
                         alt="User Image" class="profile-image profile-image-small mr-3" style="width: 32px; height: 32px;">
                    <div class="flex-1">
                        <textarea name="content" rows="1" class="reply-textarea"
                                  placeholder="ë‚´ ë‹µê¸€ì„ ê²Œì‹œí•˜ì„¸ìš”."
                                  style="width: 100%; resize: none; border: none; background: transparent; color: #E7E9EA; padding: 5px 0; outline: none;"></textarea>
                        <div style="text-align: right; margin-top: 5px;">
                            <button type="submit" class="post-submit-btn" style="padding: 5px 15px; font-size: 14px;">ë‹µê¸€</button>
                        </div>
                    </div>
                </form>
            </div>

            <div th:if="${!item.originalPost.replies.isEmpty()}" class="replies-section"
                 style="padding-top: 10px; margin-top: 10px;">
                <h4 style="color: #E7E9EA; font-size: 16px; margin-bottom: 15px; border-bottom: 1px dashed #2F3336; padding-bottom: 5px;">
                    ë‹µê¸€ (<span th:text="${#lists.size(item.originalPost.replies)}">0</span>)
                </h4>

                <div th:each="reply : ${item.originalPost.replies}" class="reply-card"
                     style="display: flex; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #2F3336;">

                    <img th:src="@{${reply.user.profileImageUrl ?: '/images/default_profile.png'}}"
                         alt="Reply Author Image" class="profile-image-small mr-3" style="width: 32px; height: 32px;">

                    <div class="flex-1">
                        <div class="reply-info flex items-center mb-1">
                            <span th:text="${reply.user.username}" class="font-bold text-white mr-2"></span>
                            <span style="color: #71767B; font-size: 13px;">
                                @<span th:text="${reply.user.username}"></span>
                            </span>
                            <span style="color: #71767B; margin-left: 5px;">Â·</span>
                            <span th:text="${#temporals.format(reply.createdAt, 'HH:mm')}"
                                  style="color: #71767B; margin-left: 5px; font-size: 13px;"></span>
                        </div>

                        <p th:text="${reply.content}" style="color: #E7E9EA; font-size: 15px;"></p>
                    </div>
                </div>
                <style>
                    .reply-card:last-child {
                        border-bottom: none !important;
                        padding-bottom: 0 !important;
                    }
                </style>
            </div>

        </div>
    </div>

    <div class="right-sidebar" style="width: 350px; padding: 10px;">
        <p style="color: #71767B;">íŠ¸ë Œë“œ ìœ„ì ¯ ì˜ì—­</p>
    </div>

</div>

<script>
    // ì „ì—­ ë©”ì‹œì§€ í•¨ìˆ˜
    window.showMessage = function(message) {
        alert(message);
    };

    // ê²Œì‹œê¸€ ì‚­ì œ (AJAX ìš”ì²­ -> ë°±ì—”ë“œ deletePost ë§¤ì¹­)
    window.deletePost = async function(postId) {
        if (!confirm('ì •ë§ ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            // POST /posts/{postId}/delete ìš”ì²­
            const response = await fetch(`/posts/${postId}/delete`, { method: 'POST' });

            if (response.ok) { // HTTP 200 OK
                const postElement = document.getElementById(`item-${postId}`);
                if (postElement) postElement.remove();
                showMessage("ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else if (response.status === 403) { // HTTP 403 Forbidden
                showMessage("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            } else if (response.status === 404) { // HTTP 404 Not Found
                showMessage("ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } else if (response.status === 401) { // HTTP 401 Unauthorized
                showMessage("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = '/users/login';
            } else {
                const errorText = await response.text();
                showMessage("ì‚­ì œ ì‹¤íŒ¨: " + errorText);
            }
        } catch (error) {
            console.error(error);
            showMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    };

    // ê²Œì‹œê¸€ ì‘ì„± (AJAX ìš”ì²­ -> ë°±ì—”ë“œ createPost ë§¤ì¹­)
    window.createPost = async function(event) {
        event.preventDefault();
        const content = document.getElementById('postContent').value.trim();
        const files = document.getElementById('postFiles').files;

        if (!content && (!files || files.length === 0)) {
            showMessage("ë‚´ìš© ë˜ëŠ” íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        const formData = new FormData();
        formData.append("content", content);
        for (let i = 0; i < files.length; i++) formData.append("mediaFiles", files[i]);

        try {
            // POST /posts ìš”ì²­
            const response = await fetch('/posts', { method: 'POST', body: formData });

            if (response.redirected) {
                window.location.href = response.url; // ë°±ì—”ë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬
            } else if (response.ok) {
                window.location.reload();
            } else {
                const errorText = await response.text();
                showMessage("ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨: " + errorText);
            }
        } catch (error) {
            console.error(error);
            showMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    };
</script>

</body>
</html>