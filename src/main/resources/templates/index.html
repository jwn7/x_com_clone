<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X.com Clone - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/style.css">

</head>
<body>

<div th:if="${signupSuccessMessage}" class="success-banner success-banner-fixed">
    <p th:text="${signupSuccessMessage}" style="margin: 0;"></p>
</div>
<div th:if="${errorMessage}" class="error-banner error-banner-fixed">
    <p th:text="${errorMessage}" style="margin: 0;"></p>
</div>
<div th:if="${successMessage}" class="success-banner success-banner-fixed">
    <p th:text="${successMessage}" style="margin: 0;"></p>
</div>


<div class="main-container">

    <div class="left-sidebar">
        <h2 class="text-3xl font-extrabold mb-6 text-white">X.com</h2>

        <a th:href="@{/}" class="menu-item">
            <span class="text-2xl">🏠</span>
            <span>홈</span>
        </a>

        <div th:if="${currentUser != null}" class="mb-4">
            <a th:href="@{/users/profile/{username}(username=${currentUser.username})}" class="menu-item">
                <span class="text-2xl">👤</span>
                <span>프로필</span>
            </a>
            <a th:href="@{/users/profile/edit}" class="menu-item">
                <span class="text-2xl">⚙️</span>
                <span>프로필 수정</span>
            </a>
        </div>

        <div th:if="${currentUser == null}" class="mt-4">
            <a th:href="@{/users/login}" class="action-button">로그인</a>
            <a th:href="@{/users/signup}" class="action-button signup-button">회원가입</a>
        </div>

        <div th:if="${currentUser != null}" class="profile-section mt-auto">
            <a th:href="@{/users/profile/{username}(username=${currentUser.username})}"
               style="text-decoration: none; display: block; color: inherit;">

                <div class="flex items-center mb-3">
                    <img th:src="@{${currentUser.profileImageUrl ?: '/images/default_profile.png'}}"
                         alt="Profile Image"
                         class="profile-image-small mr-3">

                    <div>
                        <p class="text-lg font-bold text-white" th:text="${currentUser.username} + '님'"></p>
                        <p class="text-sm" style="color: #71767B;">
                            @<span th:text="${currentUser.username}"></span>
                        </p>
                    </div>
                </div>

            </a>

            <form th:action="@{/users/logout}" method="post">
                <button type="submit" class="action-button">
                    로그아웃
                </button>
            </form>
        </div>
    </div>
    <div class="timeline">
        <div class="header">홈</div>

        <div th:if="${currentUser != null}" class="post-input-area"
             style="border-bottom: 8px solid #2F3336;">

            <form th:action="@{/posts}"
                  method="post"
                  enctype="multipart/form-data"
                  style="display: flex; flex: 1;">

                <img th:src="@{${currentUser.profileImageUrl ?: '/images/default_profile.png'}}"
                     alt="User Image"
                     class="profile-image">

                <div class="post-header-grid ml-3">
                    <textarea
                            id="postContent"
                            name="content" rows="3"
                            placeholder="무슨 일이 일어나고 있나요?"
                    ></textarea>

                    <input
                            id="postFiles"
                            type="file"
                            name="files" multiple
                            style="margin-top: 10px; color: #E7E9EA;"
                    >

                    <div style="text-align: right; border-top: 1px solid #2F3336; padding-top: 10px;">
                        <button id="postSubmitButton" type="submit"
                                class="post-submit-btn">
                            게시하기
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div th:if="${posts.isEmpty()}" class="no-posts" style="padding: 20px; text-align: center; color: #71767B;">
            <p>아직 게시물이 없습니다.</p>
        </div>

        <div th:each="post : ${posts}" class="post-card"
             th:id="|post-${post.postId}|">

            <img th:src="@{${post.user.profileImageUrl ?: '/images/default_profile.png'}}"
                 alt="Author Image"
                 class="profile-image">

            <div class="post-header-grid">
                <div class="post-info flex items-center">
                    <a th:href="@{/users/profile/{username}(username=${post.user.username})}"
                       class="profile-link flex items-center hover:text-gray-200"
                       style="text-decoration: none; color: inherit;">
                        <span th:text="${post.user.username}" class="font-bold hover:underline">Display Name</span>
                        <span style="font-weight: normal; color: #71767B; margin-left: 5px;">
                            @<span th:text="${post.user.username}">Username</span>
                        </span>
                    </a>
                    <span style="color: #71767B; margin-left: 5px;">·</span>
                    <span th:text="${#temporals.format(post.createdAt, 'HH:mm')}"
                          style="color: #71767B; margin-left: 5px;">시간</span>
                </div>

                <div class="post-content">
                    <p th:text="${post.content}">여기에 포스트 내용이 들어갑니다.</p>
                </div>

                <div class="post-images" th:if="${post.mediaList != null}">
                    <img th:each="media : ${post.mediaList}"
                         th:src="@{${media.fileUrl}}"
                         alt="첨부 이미지"
                         style="max-width: 100%; border-radius: 10px; margin-top: 10px;">
                </div>

                <div th:if="${currentUser != null and post.user.userId == currentUser.userId}"
                     style="margin-top: 10px; text-align: left;">
                    <form th:action="@{|/posts/${post.postId}/delete|}" method="post">
                        <button type="submit"
                                style="background: transparent; color: #F4212E; border: none; cursor: pointer; font-size: 14px;">
                            삭제
                        </button>
                    </form>
                </div>

                <div class="post-actions">

                    <div style="display: flex; align-items: center; gap: 10px;">

                        <form th:if="${currentUser != null}"
                              th:action="@{|/posts/${post.postId}/like|}"
                              method="post"
                              style="display: inline;">
                            <input type="hidden" name="userId"
                                   th:value="${currentUser.userId}" />
                            <button type="submit"
                                    style="background: transparent; border: none; color: #E7E9EA; cursor: pointer;">
                                ❤️
                                <span th:text="${#lists.size(post.likes)}">0</span>
                            </button>
                        </form>

                        <span th:if="${currentUser == null}">
                            ❤️ <span th:text="${#lists.size(post.likes)}">0</span>
                        </span>

                        <span style="color: #71767B; margin-left: 10px;">
                            💬 <span th:text="${#lists.size(post.replies)}">0</span> 댓글
                        </span>
                    </div>

                    <div style="margin-top: 8px; padding-left: 8px; border-left: 2px solid #2F3336;"
                         th:if="${post.replies != null and !post.replies.isEmpty()}">
                        <div th:each="reply : ${post.replies}" style="margin-bottom: 4px;">
                            <b th:text="${reply.user.username}">user</b>
                            <span style="color: #71767B; font-size: 12px; margin-left: 4px;"
                                  th:text="${#temporals.format(reply.createdAt, 'MM-dd HH:mm')}">
                                11-24 13:20
                            </span>
                            <div th:text="${reply.content}" style="margin-left: 4px;"></div>
                        </div>
                    </div>

                    <form th:if="${currentUser != null}"
                          th:action="@{|/posts/${post.postId}/reply|}"
                          method="post"
                          class="post-reply-form"
                          style="margin-top: 8px; display: flex; gap: 6px;">

                        <input type="hidden" name="userId"
                               th:value="${currentUser.userId}" />

                        <input type="text"
                               name="content"
                               placeholder="답글을 남겨보세요"
                               maxlength="280" />

                        <button type="submit"
                                class="post-reply-button">
                            답글
                        </button>
                    </form>

                    <div th:if="${currentUser == null}"
                         style="margin-top: 8px; color: #71767B; font-size: 12px;">
                        댓글과 좋아요를 남기려면
                        <a th:href="@{/users/login}" style="color: #1DA1F2;">로그인</a> 해주세요.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-sidebar" style="width: 350px; padding: 10px;">
        <p style="color: #71767B;">트렌드 위젯 영역</p>
    </div>

</div>

</body>
</html>